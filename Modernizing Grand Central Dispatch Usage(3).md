<h1><center> Modernizing Grand Central Dispatch Usage(3) </center></h1>

###### tags: `ğŸ’» WWDC ìŠ¤í„°ë””`, `ğŸ’» TIL`
###### date: `2024-01-05T15:12:33.284Z`

> [color=#724cd1][name=ë°ë¦­]
> [Modernizing Grand Central Dispatch Usage - wwdc17](https://developer.apple.com/videos/play/wwdc2017/706/)

> WWDC 2017 Session ì¤‘ í•˜ë‚˜ì¸ `Modernizing Grand Central Dispatch Usage`ì— ëŒ€í•´ ì•Œì•„ë³´ì

# ê°œìš” 

> 14:51ë¶€í„° ë‹¤ì‹œ ì‹œì‘ì´ë‹¤. (2)ì—ì„œëŠ” Concurrency, Contended Resourcesì— ëŒ€í•´ í•™ìŠµí–ˆë‹¤.

## Lock Contention

> Unfair Locks

ì´ë²ˆì—” íŒŒë€ìƒ‰ ìŠ¤ë ˆë“œê°€ ì ê¸ˆ ì¥ì¹˜ë¥¼ í•´ì œí•  ë•Œ, fair ë•Œì™€ëŠ” ë°˜ëŒ€ë¡œ ë…¹ìƒ‰ì´ ì˜ˆì•½í•  ìˆ˜ ì—†ë„ë¡ ê°€ì •í•œë‹¤. 

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-01-04 21.25.31](https://hackmd.io/_uploads/SyIpXQ4uT.png)

> íŒŒë€ìƒ‰ ìŠ¤ë ˆë“œëŠ” ì ê¸ˆ ì¥ì¹˜ì˜ ì†Œìœ ê¶Œì„ í™•ë³´í•œ ìƒíƒœ

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-01-04 21.26.08](https://hackmd.io/_uploads/SJckEXNda.png)

ë…¹ìƒ‰ì´ ì˜ˆì•½í•  ìˆ˜ ì—†ìœ¼ë‹ˆê¹Œ íŒŒë€ìƒ‰ ìŠ¤ë ˆë“œê°€ ë‹¤ì‹œ CPUë¥¼ ì ìœ í•´ì„œ Context Switchingì„ í•˜ì§€ ì•ŠëŠ”ë‹¤. 

### Use the right lock for the job

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-01-05 21.47.06](https://hackmd.io/_uploads/ByBU9_S_a.png)

## Lock Ownership

Ownership helps resolves priority inversion 

- High priority waiter
- Low priority owner

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-01-05 21.48.38](https://hackmd.io/_uploads/BJl2qOrdT.png)

Lock Trackì„ ìƒê°í•´ë³´ë©´ ëŸ°íƒ€ì„ì€ ë‹¤ìŒì— ì ê¸ˆ ì¥ì¹˜ë¥¼ ê°€ì§ˆ ìŠ¤ë ˆë“œë¥¼ ì•Œê³  ìˆë‹¤. ì´ ê¸°ëŠ¥ì„ í™œìš©í•˜ë©´ ì•±ì—ì„œ waiterì™€ ì ê¸ˆ ì¥ì¹˜ ì†Œìœ í•œ ìŠ¤ë ˆë“œ ì‚¬ì´ì˜ ìš°ì„  ìˆœìœ„ ì—­ì „ì„ ìë™ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ ìˆë‹¤. 


> Priority Inversion (ìš°ì„  ìˆœìœ„ ì—­ì „): ì´ëŠ” ë‹¤ì¤‘ ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë¬¸ì œë¡œ, ë†’ì€ ìš°ì„  ìˆœìœ„ì˜ ìŠ¤ë ˆë“œê°€ ë‚®ì€ ìš°ì„  ìˆœìœ„ì˜ ìŠ¤ë ˆë“œê°€ ê°€ì§€ê³  ìˆëŠ” ë¦¬ì†ŒìŠ¤(ì˜ˆë¥¼ ë“¤ë©´ ë½)ë¥¼ ê¸°ë‹¤ë ¤ì•¼ í•˜ëŠ” ìƒí™©ì´ë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” ë‚®ì€ ìš°ì„  ìˆœìœ„ì˜ ìŠ¤ë ˆë“œê°€ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì„ ë•Œ, ë†’ì€ ìš°ì„  ìˆœìœ„ì˜ ìŠ¤ë ˆë“œê°€ ì´ë¥¼ ëŒ€ê¸°í•˜ì§€ ì•Šê³  ê³„ì† ì§„í–‰í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤.

> Directed CPU Handoff (ì§€ì •ëœ CPU ì–‘ë„): ì´ëŠ” íŠ¹ì • ìŠ¤ë ˆë“œê°€ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ìˆëŠ” ë™ì•ˆ í•´ë‹¹ ì‘ì—…ì´ ì‹¤í–‰ë˜ëŠ” CPUë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ìŠ¤ë ˆë“œ ê°„ì˜ íš¨ìœ¨ì ì¸ ë¦¬ì†ŒìŠ¤ ê³µìœ ê°€ ê°€ëŠ¥í•˜ë©°, ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤ê³  í•œë‹¤.

> ìœ„ì˜ ë¬¸ì¥ì—ì„œëŠ” ì´ëŸ¬í•œ ë¬¸ì œë“¤ì„ ìë™ìœ¼ë¡œ í•´ê²°í•˜ëŠ” ê¸°ëŠ¥ì´ë‚˜ ìµœì í™”ë¥¼ í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì–¸ê¸‰í•˜ê³  ìˆë‹¤. ì–´ë–¤ ì†Œí”„íŠ¸ì›¨ì–´ë‚˜ ì‹œìŠ¤í…œì—ì„œ ì´ëŸ¬í•œ ìµœì í™”ë¥¼ êµ¬í˜„í•˜ë©´, ìš°ì„  ìˆœìœ„ ì—­ì „ ê°™ì€ ë¬¸ì œë¥¼ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ê±°ë‚˜ ì‘ì—…ì„ íš¨ìœ¨ì ìœ¼ë¡œ ë¶„ë°°í•˜ì—¬ ì „ì²´ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.


```
We can take advantage of that power to automatically resolve priority inversions in your app between the waiter and the onwers of the lock.

And even enable other optimizations, like directed CPU handoff to the owning thread.
```

**low-level primitives**

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-01-05 21.55.37](https://hackmd.io/_uploads/B1483uS_p.png)

> Single Ownerê°€ ê°€ì§€ëŠ” ê¸°ë³¸ ìš”ì†Œë“¤

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-01-05 21.56.50](https://hackmd.io/_uploads/SJko2ur_a.png)

> No Ownerê°€ ê°€ì§€ëŠ” ê¸°ë³¸ ìš”ì†Œë“¤

- ë¹„ëŒ€ì¹­ Primitive

Dispatch Semaphore or Dispatch Groupê³¼ ê°™ì€ ë¹„ëŒ€ì¹­ Primitiveë“¤ì€ Single Ownerê°€ ê°€ì§€ëŠ” ê¸°ëŠ¥ë“¤ì´ ì—†ë‹¤. 

-> ëŸ°íƒ€ì„ì€ ì–´ë–¤ ìŠ¤ë ˆë“œê°€ sync Primitiveë¥¼ ì‹ í˜¸í• ì§€ ëª¨ë¥´ê¸° ë•Œë¬¸

> Asymmetric Primitives (ë¹„ëŒ€ì¹­ í”„ë¦¬ë¯¸í‹°ë¸Œ): ì´ëŠ” ë™ì‹œì„±(Concurrency)ì„ ë‹¤ë£° ë•Œ ì‚¬ìš©ë˜ëŠ” ë™ê¸°í™” ê¸°ë²•ì´ë‚˜ ë©”ì»¤ë‹ˆì¦˜ì„ ë‚˜íƒ€ë‚¸ë‹¤. "Asymmetric"ì´ë¼ëŠ” ìš©ì–´ëŠ” ì´ëŸ¬í•œ ë©”ì»¤ë‹ˆì¦˜ì´ íŠ¹ì • ìŠ¤ë ˆë“œ ë˜ëŠ” ì‘ì—…ì— ëŒ€í•œ ì •ë³´ë¥¼ ê°–ì§€ ì•Šê³  ëŒ€ì¹­ì„±ì´ ì—†ë‹¤ëŠ” ê²ƒì„ ë‚˜íƒ€ë‚¸ë‹¤.

> Dispatch Semaphore and Dispatch Group: ì´ëŠ” Swiftì™€ Objective-Cì—ì„œ ì‚¬ìš©ë˜ëŠ” Grand Central Dispatch(GCD) í”„ë ˆì„ì›Œí¬ì—ì„œ ì œê³µí•˜ëŠ” ë™ê¸°í™” ê¸°ë²•ì´ë‹¤. SemaphoreëŠ” ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œì–´í•˜ëŠ” ë° ì‚¬ìš©ë˜ë©°, Groupì€ ì—¬ëŸ¬ ë¹„ë™ê¸° ì‘ì—…ì„ ì¶”ì í•˜ê³  ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦´ ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤€ë‹¤.

> ë¬¸ì¥ì—ì„œëŠ” ì´ëŸ¬í•œ ë¹„ëŒ€ì¹­ í”„ë¦¬ë¯¸í‹°ë¸Œ ì¤‘ì—ì„œë„ dispatch semaphoreì™€ dispatch groupì€ íŠ¹ì • ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë° ìˆì–´ì„œ ì œì•½ì´ ìˆë‹¤ê³  ì–¸ê¸‰í•˜ê³  ìˆë‹¤. ê·¸ ì´ìœ ëŠ” ëŸ°íƒ€ì„ì´ (í”„ë¡œê·¸ë¨ì˜ ì‹¤í–‰ í™˜ê²½ì´) í•´ë‹¹ ë™ê¸°í™” ê¸°ë²•ì„ ì‹ í˜¸ë¥¼ ë³´ë‚¼(threadì—ì„œ íŠ¹ì • ë™ì‘ì„ ìˆ˜í–‰í• ) ìŠ¤ë ˆë“œë¥¼ ë¯¸ë¦¬ ì•Œì§€ ëª»í•˜ê¸° ë•Œë¬¸ì´ë‹¤. Concurrencyì™€ ê´€ë ¨ëœ ìš°ì„ ìˆœìœ„ ì—­ì „ ê°™ì€ ë¬¸ì œë¥¼ ìë™ìœ¼ë¡œ í•´ê²°í•˜ê±°ë‚˜ ìµœì í™”í•˜ê¸° ìœ„í•´ì„œëŠ” ì–´ë–¤ ìŠ¤ë ˆë“œê°€ ì‹ í˜¸ë¥¼ ë³´ë‚¼ ê²ƒì¸ì§€ì— ëŒ€í•œ ì •ë³´ê°€ í•„ìš”í•œë°, ì´ëŸ¬í•œ ë¹„ëŒ€ì¹­ í”„ë¦¬ë¯¸í‹°ë¸ŒëŠ” ì´ ì •ë³´ë¥¼ ëŸ°íƒ€ì„ì— ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤ê³  í•œë‹¤.

```
However, asymmetric primitives, like dispatch semaphore and dispatch group don't have this power, because the runtime doesn't know what thread will signal the sync primitive.
```

![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-01-05 22.02.43](https://hackmd.io/_uploads/HygWCuBdp.png)

> Multiple Owner

**ìš”ì¦˜ì€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.**

> Primitives with Multiple Owners (ì—¬ëŸ¬ ì†Œìœ ìë¥¼ ê°€ì§„ ì›ì‹œ ë™ê¸°í™” ë©”ì»¤ë‹ˆì¦˜): ì´ëŠ” ì—¬ëŸ¬ ìŠ¤ë ˆë“œ ë˜ëŠ” ì‘ì—…ì´ ê³µìœ  ìì›ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ë™ê¸°í™”í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ë™ê¸°í™” ë©”ì»¤ë‹ˆì¦˜ì„ ë‚˜íƒ€ë‚¸ë‹¤. ì—¬ëŸ¬ ì†Œìœ ìë¥¼ ê°€ì§„ë‹¤ëŠ” ê²ƒì€ ì—¬ëŸ¬ ìŠ¤ë ˆë“œë‚˜ ì‘ì—…ì´ ì´ ë©”ì»¤ë‹ˆì¦˜ì„ ì†Œìœ í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤.

> Private, Concurrent Queues, and Reader or Writer Locks (ê°œì¸, ë™ì‹œ í ë° ì½ê¸° ë˜ëŠ” ì“°ê¸° ë½): ì—¬ëŸ¬ ìŠ¤ë ˆë“œ ê°„ì˜ ìì› ê³µìœ  ë° ë™ê¸°í™”ë¥¼ ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ë‹¤ì–‘í•œ ë©”ì»¤ë‹ˆì¦˜ë“¤ì„ ë‚˜íƒ€ë‚¸ë‹¤. Private queuesëŠ” ê°œë³„ ìŠ¤ë ˆë“œ ë˜ëŠ” ì‘ì—…ì— ì†í•˜ëŠ” íë¥¼ ì˜ë¯¸í•˜ë©°, Concurrent queuesëŠ” ì—¬ëŸ¬ ì‘ì—…ì´ ë™ì‹œì— ì‹¤í–‰ë  ìˆ˜ ìˆëŠ” íë¥¼ ë‚˜íƒ€ë‚¸ë‹¤. Reader-writer locksëŠ” ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ìì›ì„ ì½ì„ ìˆ˜ ìˆê³ , ì“°ê¸° ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ê²½ìš°ì—ëŠ” ë‹¨ì¼ ìŠ¤ë ˆë“œë§Œì´ ì´ë¥¼ ì†Œìœ í•˜ë„ë¡ í•˜ëŠ” ë™ê¸°í™” ë©”ì»¤ë‹ˆì¦˜ì´ë‹¤.

> ë¬¸ì¥ì—ì„œëŠ” ì´ëŸ¬í•œ ì—¬ëŸ¬ ì†Œìœ ìë¥¼ ê°€ì§„ ì›ì‹œ ë™ê¸°í™” ë©”ì»¤ë‹ˆì¦˜ë“¤ì´ í˜„ì¬ ì‹œìŠ¤í…œì—ì„œ ì¶©ë¶„íˆ íš¨ê³¼ì ìœ¼ë¡œ í™œìš©ë˜ì§€ ëª»í•˜ëŠ” ì´ìœ ì— ëŒ€í•´ ì–¸ê¸‰í•˜ê³  ìˆë‹¤. ê·¸ ì´ìœ ëŠ” í˜„ì¬ì˜ ì‹œìŠ¤í…œì—ì„œëŠ” ì´ëŸ¬í•œ ë©”ì»¤ë‹ˆì¦˜ì´ í•˜ë‚˜ì˜ ë‹¨ì¼ ì†Œìœ ìë¥¼ ê°–ì§€ ì•Šê¸° ë•Œë¬¸ì´ë‹¤. ì‹œìŠ¤í…œì´ ì´ëŸ¬í•œ ì—¬ëŸ¬ ì†Œìœ ì ë©”ì»¤ë‹ˆì¦˜ì„ ìµœì í™”í•˜ê±°ë‚˜ íš¨ê³¼ì ìœ¼ë¡œ í™œìš©í•˜ë ¤ë©´ ì–´ë–»ê²Œ ì†Œìœ ê¶Œì´ ê³µìœ ë˜ê³  í•´ì œë˜ëŠ”ì§€ì— ëŒ€í•œ ëª…í™•í•œ ë°©ë²•ì´ í•„ìš”í•  ê²ƒì´ë‹¤.

```
Finally, primitives with multiple owner like private, concurrent queues and reader or writers locks, the system doesn;t take advantage of that today, because there isn't a single owner.

```

primitiveë¥¼ ì„ íƒí•  ë•Œ, ì„œë¡œ ë‹¤ë¥¸ ìš°ì„  ìˆœìœ„ì˜ ìŠ¤ë ˆë“œê°€ ìƒí˜¸ ì‘ìš©í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ê³ ë ¤í•´ì•¼ í•œë‹¤. 

ìš°ì„  ìˆœìœ„ê°€ ë‚®ì€ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œë¥¼ ì‹¤í–‰í•˜ë©´ì„œ UI ìŠ¤ë ˆë“œê°€ ì§€ì—°ë˜ì§€ ì•Šë„ë¡ ë³´ì¥í•˜ëŠ” ownershipì´ ìˆëŠ” primitiveë¥¼ í™œìš©í•˜ë¼.

### Optimizing Lock Contention

- Inefficient behaviors are often emergent properties
- Visualize your app's behavior with Instruments
- Use the right lock for the job


#### Too Much of a Good Thing

- Repeatedly waiting for exclusive access to contended resources
- Repeatedly switching between independent operations
- Repeatedly bouncing an operation between threads

