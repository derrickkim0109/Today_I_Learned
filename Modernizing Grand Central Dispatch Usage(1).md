<h1><center> Modernizing Grand Central Dispatch Usage(1) </center></h1>

###### tags: `ğŸ’» WWDC ìŠ¤í„°ë””`
###### date: `2023-06-13T15:12:33.284Z`

> [color=#724cd1][name=ë°ë¦­]
> [Modernizing Grand Central Dispatch Usage - wwdc17](https://developer.apple.com/videos/play/wwdc2017/706/)

> [Blog](https://wlaxhrl.tistory.com/91)

> WWDC 2017 Session ì¤‘ í•˜ë‚˜ì¸ `Modernizing Grand Central Dispatch Usage`ì— ëŒ€í•´ ì•Œì•„ë³´ì

# ê°œìš”

`Application`ì—ì„œ ìµœìƒì˜ ì„±ëŠ¥ì„ ìœ„í•´ `Grand Central Dispatch`ë¥¼ í™œìš©í•˜ëŠ” ë°©ë²•ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•œ WWDCì´ë‹¤.

GCDëŠ” `Application` ì½”ë“œë¥¼ ë™ì ìœ¼ë¡œ í™•ì¥í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
ì‹±ê¸€ ì½”ì–´ Apple Watchì—ì„œ ë¯¸ë‹ˆ ì½”ì–´ Macê¹Œì§€ ì‚¬ìš©ìê°€ ì–´ë–¤ ì¢…ë¥˜ì˜ í•˜ë“œì›¨ì–´ë¥¼ ì‹¤í–‰í•˜ê³  ìˆëŠ”ì§€ì— ëŒ€í•´ ë„ˆë¬´ ë§ì´ ê±±ì •í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. 

**ê·¸ëŸ¬ë‚˜ ì½”ë“œì˜ í™•ì¥ì„±ê³¼ íš¨ìœ¨ì„±ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆëŠ” ë¬¸ì œê°€ ìˆë‹¤**

- ë””ìŠ¤íŒ¨ì¹˜ ë¹„ë™ê¸°ì™€ ê°™ì€ GCD APIë¥¼ ì‚¬ìš©í•´ì„œ íë¥¼ ìƒì„±í•˜ê³  ì‘ì—…ì„ ì‹œìŠ¤í…œì— ë””ìŠ¤íŒ¨ì¹˜ í•  ìˆ˜ ìˆë‹¤.
    - ìš°ë¦¬ê°€ Grand Central Dispatchë¼ê³  ë¶€ë¥´ëŠ” ë™ì‹œì„± ê¸°ìˆ ì— ëŒ€í•œ ì¸í„°í˜ì´ìŠ¤ ì¤‘ ì¼ë¶€ì— ë¶ˆê³¼


## Efficiency Through Observation
> Going off core during an operation reduces efficiency 

ì½”ë“œê°€ ì‘ì—…ì„ ì™„ë£Œí•˜ê¸° ì „ì— ì½”ì–´ì—ì„œ ë²—ì–´ë‚˜ë©´ í•´ë‹¹ ì½”ì–´ê°€ êµ¬ì¶•í•œ ê¸°ë¡ì„ ë” ì´ìƒ í™œìš©í•˜ì§€ ëª»í•  ìˆ˜ ìˆë‹¤.

![](https://hackmd.io/_uploads/Byj5MoSv2.png)


## Parallelism and concurrency

ë³‘ë ¬ì„±ê³¼ ë™ì‹œì„±ì„ ê°€ì¥ ì˜ í‘œí˜„í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì— ëŒ€í•´ ë…¼ì˜ í•´ë³´ì.!

Parallelism - ì—¬ëŸ¬ ì½”ì–´ê°€ í•„ìš”í•˜ê³  ë™ì‹œì— ëª¨ë‘ ì‚¬ìš©í•˜ë ¤ëŠ” ê²ƒ

Concurrency - ë™ì‹œì— ì‹¤í–‰í•  ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ë…ë¦½ êµ¬ì„± ìš”ì†Œë¥¼ êµ¬ì„±í•˜ëŠ” ë°©ë²•ì— ê´€í•œ ê²ƒ
    - ë‹¨ì¼ ì½”ì–´ ì‹œìŠ¤í…œì—ì„œë„ ìˆ˜í–‰ê°€ëŠ¥í•˜ë‹¤.
> Composition of independently executed tasks


### Parallelism
> Simultaneous execution of closely related computations

ì˜ˆì‹œ) ì•±ì„ ë§Œë“¤ê³  ê±°ëŒ€í•œ ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•œë‹¤ê³  ìƒìƒí•´ ë³´ì. 

![](https://hackmd.io/_uploads/HJXZciBP2.png)


ê·¸ë¦¬ê³  ì´ëŸ¬í•œ ì´ë¯¸ì§€ë¥¼ ë” ë¹ ë¥´ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ Mac Proì˜ ë§ì€ ì½”ì–´ë¥¼ í™œìš©í•  ìˆ˜ ìˆê¸¸ ì›í•œë‹¤ë©´ ë‚´ê°€ í•  ì¼ì€ ê·¸ ì´ë¯¸ì§€ë¥¼ ë©ì–´ë¦¬ë¡œ ë‚˜ëˆ„ëŠ” ê²ƒì´ë‹¤.
ê·¸ë¦¬ê³  ê° ì½”ì–´ê°€ í•´ë‹¹ ë©ì–´ë¦¬ë“¤ì„ ë³‘ë ¬ë¡œ ì²˜ë¦¬í•˜ë„ë¡ í•œë‹¤.

![](https://hackmd.io/_uploads/B17Z5irPh.png)

 ì½”ì–´ê°€ ì´ë¯¸ì§€ì˜ ë‹¤ë¥¸ ë¶€ë¶„ë“¤ì„ ë™ì‹œì— ì‘ì—…í•˜ê¸° ë•Œë¬¸ì— ì†ë„ê°€ ë¹¨ë¼ì§„ë‹¤.
 
 **ì´ê±¸ ì–´ë–»ê²Œ êµ¬í˜„í•´ì•¼ í• ê¹Œ?**
 
 ìš°ì„ , ì‹œìŠ¤í…œ í”„ë ˆì„ì›Œí¬ë¥¼ í™œìš©í•  ìˆ˜ ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ê³ ë ¤í•´ì•¼ í•œë‹¤. 
 
 ![](https://hackmd.io/_uploads/BJHaqorwn.png)

### Parallelism with GCD

 ì˜ˆë¥¼ ë“¤ì–´ Accelerateì—ëŠ” ê³ ê¸‰ ì´ë¯¸ì§€ ì•Œê³ ë¦¬ì¦˜ì˜ ë³‘ë ¬ ì‹¤í–‰ì„ ê¸°ë³¸ì ìœ¼ë¡œ ì§€ì›í•œë‹¤.
 
 ë©”íƒˆ, ì½”ì–´ì˜ ì´ë¯¸ì§€ëŠ” ê°•ë ¥í•œ GPUë¥¼ í™œìš©í•  ìˆ˜ ìˆë‹¤.
 
 ì´ê²ƒì„ ì§ì ‘ êµ¬í˜„í•˜ê¸°ë¡œ ê²°ì •í–ˆë‹¤ë©´? 
 GCDë¥¼ ì‚¬ìš©í•˜ë¼.
 - ì´ íŒ¨í„´ì„ ì‰½ê²Œ í‘œí˜„í•  ìˆ˜ ìˆëŠ” toolì„ ì œê³µí•œë‹¤.

ì´ë•Œ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” APIëŠ” GCDì—ì„œ ë³‘ë ¬ì„ í‘œí˜„í•˜ëŠ” `concurrentPerform`ì´ë‹¤.

ì´ë ‡ê²Œ í•˜ë©´ í”„ë ˆì„ì›Œí¬ê°€ ëª¨ë“  ì½”ì–´ì—ì„œ ë³‘ë ¬ ê³„ì‚°ì„ ìˆ˜í–‰í•˜ë ¤ í•œë‹¤ëŠ” ê²ƒì„ ì•Œê¸° ë•Œë¬¸ì— ë³‘ë ¬ ì‚¬ë¡€ë¥¼ ìµœì í™” í•  ìˆ˜ ìˆë‹¤.

![](https://hackmd.io/_uploads/SJ1ijjSwn.png)

`concurrentPerform`ì€ ì‹œìŠ¤í…œì˜ ëª¨ë“  ì½”ì–´ì—ì„œ ê³„ì‚°ì„ ìë™ìœ¼ë¡œ ë¶€í•˜ì˜ ì •ë„ë¥¼ ê· í˜• ì¡ì•„ ì£¼ëŠ” ë³‘ë ¬ for ë£¨í”„ì´ë‹¤.

```swift 
DispatchQueue.concurrentPerform(1000) { i in /* iteration i */ }
                                       
                                       
dispatch_apply(DISPATCH_APPLY_AUTO, 1000 ^(size_t i) { /* iteration i */ })
```

- `1000`ì€ ì‹œìŠ¤í…œ ì „ì²´ì—ì„œ ë¸”ë¡ì´ ë³‘ë ¬ë¡œ í˜¸ì¶œë˜ëŠ” íšŸìˆ˜ì´ë‹¤.



![](https://hackmd.io/_uploads/SJ19niBP2.png)
- three-core system

```swift 
DispatchQueue.concurrentPerform(3) { i in /* iteration i */ }

```

> ì—¬ê¸°ì—ì„œëŠ” 3ê°œì˜ ë¸”ë¡ì´ 3ê°œì˜ ì½”ì–´ì—ì„œ ë³‘ë ¬ë¡œ ì‹¤í–‰ë˜ëŠ” ì´ìƒì ì¸ ê²½ìš°ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.

![](https://hackmd.io/_uploads/H1tGTsrP3.png)

**ë§Œì•½ì— UI ë Œë”ë§ì„ ìœ„í•´ ì„¸ ë²ˆì§¸ ì½”ì–´ë¥¼ ì ì‹œ ì‚¬ìš©í•˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ?**

Load BalancerëŠ” UI ë Œë”ë§ì„ ìœ„í•´ ì„¸ ë²ˆì§¸ ë¸”ë¡ì„ ì²« ë²ˆì§¸ ì½”ì–´ë¡œ ì˜®ê²¨ì•¼ í•œë‹¤.

![](https://hackmd.io/_uploads/HJjtaiBw2.png)

> we get a bubble of idel CPU(?)

ì´ ì‹œê°„ì„ í™œìš©í•˜ì—¬ ë” ë§ì€ ë³‘ë ¬ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì‘ì—…ì´ ëŒ€ì‹  ë” ì˜¤ë˜ ê±¸ë¦¼.

**ì–´ë–»ê²Œ í•´ê²°í•  ìˆ˜ ìˆì„ê¹Œ?**

ë°˜ë³µ íšŸìˆ˜ë¥¼ ëŠ˜ë¦¬ê³  ë¡œë“œ ë°¸ëŸ°ì„œì— ë” ë§ì€ ìœ ì—°ì„±ì„ ì œê³µí•˜ë¼.?

![](https://hackmd.io/_uploads/BkF-AjrD3.png)

```swift 
DispatchQueue.concurrentPerform(6) { i in /* iteration i */ }

```

ì„¸ ë²ˆì§¸ ì½”ì–´ì— ë˜ ë‹¤ë¥¸ ë²„ë¸”ì´ ìˆìŒ
![](https://hackmd.io/_uploads/S10LCirDh.png)

ì´ ì‹œê°„ë„ í™œìš©í•  ìˆ˜ ìˆë‹¤.

![](https://hackmd.io/_uploads/HyVKCiHPn.png)

```swift 
DispatchQueue.concurrentPerform(11) { i in /* iteration i */ }

```

> Load Balancerê°€ ì‹œìŠ¤í…œì˜ ê²©ì°¨ë¥¼ ë©”ìš°ê³  ì‹œìŠ¤í…œì˜ ì‚¬ìš© ê°€ëŠ¥í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ìµœëŒ€í•œ í™œìš©í•  ìˆ˜ ìˆëŠ” ìœ ì—°ì„±ì„ ê°–ë„ë¡ ì¶©ë¶„íˆ í° ë°˜ë³µ íšŸìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

> Load Balancerì˜ ì˜¤ë²„í—¤ë“œì™€ ë²™ë ¬ for ë£¨í”„ì˜ ê° ë¸”ë¡ì´ ìˆ˜í–‰í•˜ëŠ” ìœ ìš©í•œ ì‘ì—… ì‚¬ì´ì˜ ê· í˜•ì„ ìœ ì§€í•´ì•¼ í•œë‹¤.


- ëª¨ë“  CPUë¥¼ í•­ìƒ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê²ƒì€ ì•„ë‹˜.
    - ì‹œìŠ¤í…œì—ëŠ” ë™ì‹œì— ì‹¤í–‰ë˜ëŠ” ë§ì€ ì‘ì—…ì´ ìˆìŒ
    - ë˜í•œ, ëª¨ë“  ì‘ì—…ì ìŠ¤ë ˆë“œê°€ ë™ì¼í•˜ê²Œ ì§„í–‰ë˜ëŠ” ê²ƒì€ ì•„ë‹˜


**Summary**
> ë³‘ë ¬ ë¬¸ì œê°€ ìˆëŠ” ê²½ìš° ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œìŠ¤í…œ í”„ë ˆì„ì›Œí¬ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
- conccurenPerformì„ ì‚¬ìš©í•´ì„œ ë‚´ë¶€ì˜ ìë™ ë¡œë“œ ë°¸ëŸ°ì‹±ì„ í™œìš©í•´ì•¼ í•œë‹¤.


### Concurrency

ê°„ë‹¨í•œ ë‰´ìŠ¤ ì•±ì„ ì‘ì„±í•˜ê³  ìˆë‹¤ê³  ê°€ì •í•´ë³´ì. 
ì–´ë–»ê²Œ êµ¬ì„±í• ê¹Œìš”?
ì•±ì„ êµ¬ì„±í•˜ëŠ” ë…ë¦½ì ì¸ í•˜ìœ„ ì‹œìŠ¤í…œìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ê²ƒë¶€í„° ì‹œì‘í•œë‹¤.

ë‰´ìŠ¤ ì•±ì„ ë…ë¦½ëœ í•˜ìœ„ ì‹œìŠ¤í…œìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ë°©ë²•ì„ ìƒê°í•˜ë©´ UIë¥¼ ë Œë”ë§í•˜ëŠ” UI ì»´í¬ë„ŒíŠ¸ë“¤ì´ ìˆì„ ìˆ˜ ìˆë‹¤. ì´ê²ƒì´ ê¸°ë³¸ ìŠ¤ë ˆë“œì´ë‹¤(?).

![](https://hackmd.io/_uploads/SJ0Qgnrw2.png)


![](https://hackmd.io/_uploads/rJa-ZhHvh.png)

í˜„ì¬ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì•±ì˜ ë©”ì¸ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— OSëŠ” ì¦‰ì‹œ CPUë¥¼ UI ìŠ¤ë ˆë“œì—ì„œ ì‘ì—…í•˜ë„ë¡ ì „í™˜í•  ìˆ˜ ìˆìœ¼ë©° ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤ë ˆë“œê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦´ í•„ìš” ì—†ì´ ì‚¬ìš©ìì—ê²Œ ì¦‰ì‹œ ì‘ë‹µí•  ìˆ˜ ìˆë‹¤.

- Main Threadì˜ ì´ì 

ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ê°€ ì‘ë‹µì„ ì™„ë£Œí•˜ë©´ CPUëŠ” ë‹¤ì‹œ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤ë ˆë“œë¡œ ì „í™˜í•œ ë‹¤ìŒ ë„¤íŠ¸ì›Œí‚¹ ì‘ì—…ë„ ì™„ë£Œí•  ìˆ˜ ìˆë‹¤.

-> ë”°ë¼ì„œ ì´ì™€ ê°™ì€ ë™ì‹œì„±ì„ í™œìš©í•˜ë©´ ë°˜ì‘í˜• ì•±ì„ êµ¬ì¶•í•  ìˆ˜ ìˆë‹¤.
![](https://hackmd.io/_uploads/rkSQ7TSv3.png)

> Main ThreadëŠ” ì•±ì˜ ë‹¤ë¥¸ ë¶€ë¶„ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦´ í•„ìš” ì—†ì´ í•­ìƒ ì‚¬ìš©ì ì‘ì—…ì— ì‘ë‹µí•  ìˆ˜ ìˆë‹¤. 


### Context switching

ì´ì œ CPUê°€ ì–´ë–»ê²Œ ìƒê²¼ëŠ”ì§€ ì‚´í´ë³´ì.

![](https://hackmd.io/_uploads/ryUO7aSv2.png)

- í°ìƒ‰ ì„ ì€ í•˜ìœ„ ì‹œìŠ¤í…œ ê°„ì˜ Context Switchingì„ ë³´ì—¬ì£¼ëŠ” ê²ƒ

> `Context Switching`ì€ ì•±ì„ êµ¬ì„±í•˜ëŠ” ì„œë¡œ ë‹¤ë¥¸ í•˜ìœ„ ì‹œìŠ¤í…œ ë˜ëŠ” ìŠ¤ë ˆë“œ ê°„ì— CPUê°€ ì „í™˜í•˜ëŠ” ê²½ìš°ë¥¼ ë§í•œë‹¤.

**Instrument System Trace**
> ì•±ì´ ì–´ë–»ê²Œ ë³´ì´ëŠ”ì§€ ì‹œê°í™”í•˜ê³  ì‹¶ë‹¤ë©´ CPUì™€ ìŠ¤ë ˆë“œê°€ ì•±ì—ì„œ ì‹¤í–‰ ì¤‘ì¼ ë•Œ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

ì‹œìŠ¤í…œ ì¶”ì²™ì„ ì¢€ ë” ìì„¸íˆ ì•Œê³  ì‹¶ìœ¼ë©´
**System Trace In-Depth** ê°•ì—°ì„ ì°¸ê³ í•˜ë¼.

ë”°ë¼ì„œ Context Switching ê°œë…ì˜ ë™ì‹œì„±ì˜ íŒŒì›Œê°€ ë‚˜ì˜¤ëŠ” ê³³ì´ë‹¤.

**Context Switching ë°œìƒí•  ìˆ˜ ìˆëŠ” ì‹œê¸°**

![](https://hackmd.io/_uploads/B19pNprPh.png)


ìŠ¤ë ˆë“œê°€ í˜„ì¬ ì‘ì—…ì„ ì™„ë£Œí•˜ê±°ë‚˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì–»ê¸° ìœ„í•´ ëŒ€ê¸° ì¤‘ì¸ ê²½ìš°ì—ë„ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

![](https://hackmd.io/_uploads/rJTgBprD2.png)

![](https://hackmd.io/_uploads/B1AbHpSv3.png)

**Context Switching ì›ì¸**
![](https://hackmd.io/_uploads/rJkVBpHP2.png)

ë„ˆë¬´ ë§ì´ ë°˜ë³µí•˜ë©´ ë¹„ìš©ì´ í•©ì‚°ë˜ê¸° ì‹œì‘í•œë‹¤.

1. Contented Resourceì— ëŒ€í•œ ë°°íƒ€ì ì¸ ì ‘ê·¼

- ì´ëŸ° ì¼ì´ ë°œìƒí•˜ëŠ” ì£¼ëœ ê²½ìš°
    - ì ê¸ˆì¥ì¹˜ê°€ ìˆì„ ë•Œ, ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ëª¨ë‘ ì ê¸ˆì¥ì¹˜ë¥¼ ì–»ì„ë ¤ê³  ì‹œë„í•˜ëŠ” ê²½ìš°

![](https://hackmd.io/_uploads/SJ7hSaHP2.png)

ê·¸ë ‡ë‹¤ë©´ ì´ê²ƒì´ ì•±ì—ì„œ ë°œìƒí•˜ê³  ìˆë‹¤ëŠ” ê²ƒì„ ì–´ë–»ê²Œ ì•Œ ìˆ˜ ìˆì„ê¹Œ? 

-> System Trace

![](https://hackmd.io/_uploads/S11kL6Hw3.png)

- ì‹œê°í™”í•œ ì´ë¯¸ì§€

ì´ëŠ” ë§¤ìš° ì§§ì€ ì‹œê°„ ë™ì•ˆ ì‹¤í–‰ë˜ëŠ” ë§ì€ ìŠ¤ë ˆë“œê°€ ìˆê³  ëª¨ë‘ ì•½ê°„ì˜ cascadeì—ì„œ ì„œë¡œì—ê²Œ ì „ë‹¬ë˜ê³  ìˆìŒì„ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ë‹¤.

**íŒŒë€ìƒ‰ íŠ¸ë™** - ìŠ¤ë ˆë“œê°€ CPUì— ìˆì„ ë–„ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.

**ë¹¨ê°„ìƒ‰ íŠ¸ë™** - ì‹œìŠ¤í…œ í˜¸ì¶œì„ í•  ë•Œ ë‚˜íƒ€ë‚œë‹¤.

ì²« ë²ˆì§¸ ë¼ì¸ì€ ëŒ€ë¶€ë¶„ì˜ ì‹œê°„ì—ì„œ ë®¤í…ìŠ¤ê°€ ì‚¬ìš© ê°€ëŠ¥í•´ì§€ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŒì„ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ë‹¤(?)

![](https://hackmd.io/_uploads/S1V58TrDn.png)


### Lock Contention
> Fair locks

![](https://hackmd.io/_uploads/SkrkDTBD2.png)

- ì ê¸ˆ ìƒíƒœì™€ ì´ë¥¼ ì†Œìœ í•œ ìŠ¤ë ˆë“œë¥¼ í‘œì‹œí•˜ëŠ” ìƒˆ ì ê¸ˆ íŠ¸ë™ì„ ì¶”ê°€í–ˆë‹¤.
- ì´ ê²½ìš° íŒŒë€ìƒ‰ ìŠ¤ë ˆë“œê°€ ì ê¸ˆì„ ì†Œìœ í•˜ê³  ë…¹ìƒ‰ ìŠ¤ë ˆë“œê°€ ëŒ€ê¸°í•œë‹¤.

![](https://hackmd.io/_uploads/S1jVPpHDh.png)

- íŒŒë€ìƒ‰ ìŠ¤ë ˆë“œê°€ ì ê¸ˆ í•´ì œë˜ë©´ í•´ë‹¹ ì ê¸ˆì˜ ì†Œìœ ê¶Œì€ ë‹¤ìŒ ì¤„ì— ìˆëŠ” ë…¹ìƒ‰ ìŠ¤ë ˆë“œë¡œ ì´ì „ëœë‹¤.
- ê·¸ëŸ¬ë‚˜ íŒŒë€ìƒ‰ ìŠ¤ë ˆë“œê°€ ëŒì•„ì„œì„œ ë‹¤ì‹œ ì ê¸ˆì„ ì¡ìœ¼ë©´ ì ê¸ˆì´ ë…¹ìƒ‰ ìŠ¤ë ˆë“œìš©ìœ¼ë¡œ ì˜ˆì•½ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ì ê¸ˆì„ í•  ìˆ˜ ì—†ë‹¤.

![](https://hackmd.io/_uploads/r1Z2D6BPh.png)

- ì´ì œ ë‹¤ë¥¸ ì‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ì»¨í…ìŠ¤íŠ¸ ì „í™˜ì„ ê°•ì œí•©ë‹ˆë‹¤.

![](https://hackmd.io/_uploads/ryoaw6Hwh.png)

- ë…¹ìƒ‰ ìŠ¤ë ˆë“œë¡œ ì „í™˜ì´ ë˜ë©´ CPUê°€ ì ê¸ˆì„ ì™„ë£Œí•˜ê³  ë°˜ë³µí•  ìˆ˜ ìˆë‹¤.


ì ê¸ˆì„ ê¸°ë‹¤ë¦¬ê³  ìˆëŠ” ëª¨ë“  ìŠ¤ë ˆë“œê°€ ë¦¬ì†ŒìŠ¤ë¥¼ íšë“í•  ê¸°íšŒë¥¼ ì–»ìœ¼ë ¤í•˜ì§€ë§Œ ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ì‘ë™í•˜ëŠ” ì ê¸ˆì´ ìˆëŠ” ê²½ìš°(?)ì• ëŠ” ì–´ë–»ê²Œ ë©ë‹ˆê¹Œ?

### unfair lockì´ ë¬´ì—‡ì„ í•˜ëŠ”ì§€ ì‚´í´ë³´ì.

![](https://hackmd.io/_uploads/BkaVuaBvn.png)

- ì´ë²ˆì—ëŠ” íŒŒë€ìƒ‰ ìŠ¤ë ˆë“œê°€ ì ê¸ˆ í•´ì œë  ë•Œ ì ê¸ˆì´ ì˜ˆì•½ë˜ì§€ ì•ŠëŠ”ë‹¤

![](https://hackmd.io/_uploads/SJ0UO6BD3.png)

- ì ê¸ˆì¥ì¹˜ì˜ ì†Œìœ ê¶Œì„ ê°€ì§€ê²Œ ëœë‹¤.

![](https://hackmd.io/_uploads/SJ4tOpHv3.png)

- BlueëŠ” ì ê¸ˆ ì¥ì¹˜ë¥¼ ë‹¤ì‹œ ê°€ì§ˆ ìˆ˜ ìˆê³  Context Switchingì„ ê°•ì œí•˜ì§€ ì•Šê³  ì¦‰ì‹œ ë‹¤ì‹œ íšë“í•˜ì—¬ CPUì— ë¨¸ë¬´ë¥¼ ìˆ˜ ìˆë‹¤.

-> ë…¹ìƒ‰ ìŠ¤ë ˆë“œê°€ ì ê¸ˆ ì¥ì¹˜ë¥¼ ì–»ëŠ” ê¸°íšŒë¥¼ ì–´ë µê²Œ ë§Œë“¤ ìˆ˜ ìˆì§€ë§Œ, íŒŒë€ìƒ‰ ìŠ¤ë ˆë“œê°€ ì ê¸ˆ ì¥ì¹˜ë¥¼ ë‹¤ì‹œ íšë“í•˜ê¸° ìœ„í•´ í•„ìš”í•œ Context Switchingì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.

![](https://hackmd.io/_uploads/r1ebt6rw2.png)

![](https://hackmd.io/_uploads/ryqmY6HD2.png)


## low-level primitive

**Single Owner**

![](https://hackmd.io/_uploads/S1zc2THv2.png)

**No Owner**

![](https://hackmd.io/_uploads/H1O6npBDh.png)

- ëŸ°íƒ€ì„ì— ì–´ë–¤ ìŠ¤ë ˆë“œê°€ ë™ê¸°í™” primitiveë¥¼ í˜¸ì¶œí•  ì§€ëª¨ë¥´ê¸° ë•Œë¬¸ì— Single Ownerì˜ ê¸°ëŠ¥ì´ ì—†ë‹¤.

**Multi Owner**

![](https://hackmd.io/_uploads/Bk2kT6HPh.png)

- ì—¬ëŸ¬ ì†Œìœ ìê°€ ìˆëŠ” ê¸°ë³¸ ìš”ì†ŒëŠ” Sinle onwerê°€ ì—†ê¸° ë•Œë¬¸ì— ì˜¤ëŠ˜ë‚ ì˜ ì‹œìŠ¤í…œì€ ì´ë¥¼ í™œìš©í•˜ì§€ ì•ŠìŒ.


> Primitiveë¥¼ ì„ íƒí•  ë•Œ ì„œë¡œ ë‹¤ë¥¸ ìš°ì„  ìˆœìœ„ì˜ ìŠ¤ë ˆë“œê°€ ìƒí˜¸ ì‘ìš©í•˜ëŠ”ì§€ ì—¬ë¶€ë¥¼ ê³ ë ¤í•˜ë¼.

ìš°ì„ ìˆœìœ„ê°€ ë‚®ì€ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œ, ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ UI ìŠ¤ë ˆë“œê°€ ìˆë‹¤ê³  ê°€ì •í•˜ì.

-> ìš°ì„  ìˆœìœ„ê°€ ë‚®ì€ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œì—ì„œ ëŒ€ê¸°í•˜ì—¬ UI ìŠ¤ë ˆë“œê°€ ì§€ì—°ë˜ì§€ ì•Šë„ë¡ í•˜ëŠ” Onwerê°€ ìˆëŠ” Primitiveë¥¼ í™œìš©í•  ìˆ˜ ìˆë‹¤.

![](https://hackmd.io/_uploads/H1hRp6Svn.png)


# Using GCD for Concurrency

- GCD ê¸°ì´ˆëŠ” ì•„ë˜ WWDCë¥¼ ì°¸ê³ 

![](https://hackmd.io/_uploads/H1xmApBDh.png)


## Serial Dispatch Queue

> GCDì˜ ê¸°ë³¸ì ì¸ ë™ê¸°í™” Primitive


- ìƒí˜¸ ë°°ì œ
- FIFO ìˆœì„œë¥¼ ì œê³µ
- Concurrent atomic enqueue
    - ë™ì‹œ ì›ìì  ì¸í ì‘ì—…ì€ ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ íì— ë™ì‹œì— ì‘ì—…í•  ë•Œ
- Single dequeuer
    - ì‹œìŠ¤í…œì´ íì—ì„œ ë¹„ë™ê¸° ì‘ì—…ì„ ì‹¤í–‰í•  ë•Œ

![](https://hackmd.io/_uploads/Skg7ckABvh.png)

```swift 
let queue = DispatchQueue(label: "com.exaple.queue")
queue.async { /* 1 */ }
queue.async { /* 2 */ }
queue.sync { /* 3 */ }
```

- DispatchQueue ìƒì„±ìë¥¼ í˜¸ì¶œí•˜ì—¬ ì§ì—´ ëŒ€ê¸°ì—´ì„ ë§Œë“¤ê³  ìˆëŠ” ìƒíƒœì´ë©°, ì‚¬ìš©í•˜ì§€ ì•Šì€ í•œ ì‘ìš©í”„ë¡œê·¸ë¨ì—ì„œ ë¹„í™œì„± ìƒíƒœì¸ ë©”ëª¨ë¦¬ë¥¼ ì œê³µí•œë‹¤. 

![](https://hackmd.io/_uploads/Byc7gAHPh.png)

ìœ„ì˜ ë‘ ì‘ì—…ë“¤ì€ ë¹„ë™ê¸°ì´ê¸° ë•Œë¬¸ì— ì²« ë²ˆì§¸ ìŠ¤ë ˆë“œê°€ ê²°êµ­ `queue.sync`ë¥¼ í˜¸ì¶œí•  ìˆ˜ ì‡ë‹¤. ì´ê²ƒì´ Queueì™€ synchronousê°€ ìƒí˜¸ ì‘ìš©í•˜ëŠ” ë°©ì‹ì´ë‹¤.

- ordered primitive
- ìŠ¤ë ˆë“œê°€ ìì‹ ì˜ ì°¨ë¡€ê°€ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦´ ìˆ˜ ìˆë„ë¡ placeholderë¥¼ ëŒ€ê¸°ì—´ì— ë„£ëŠ” ê²ƒì´ë‹¤.

![](https://hackmd.io/_uploads/S1xgVCBvn.png)

## GCD Event Monitoring Primitive 

```swift 
let source = DispatchSource.makeReadSource(fileDescription: fd, queue: queue)
source.setEventHandler { read(fd) }
source.setCancelHandler { close(fd) }
source.activate()
```
This target queue is also where you might put other work that should be serialized with this operation, such as processing the data that was read.

- ì´ target íëŠ” setEventHandlerì™€ ê°™ì´ ì´ ì‘ì—…ìœ¼ë¡œ ì§ë ¬í™”í•´ì•¼ í•˜ëŠ” ë‹¤ë¥¸ ì‘ì—…ì„ ë°°ì¹˜í•  ìˆ˜ë„ ìˆëŠ” ê³³ì…ë‹ˆë‹¤.

- ê·¸ëŸ° ë‹¤ìŒ ì†ŒìŠ¤ê°€ ë¬´íš¨í™” íŒ¨í„´(invalidation pattern)ì„ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì¸ setCancelHandlerë¥¼ ì„¤ì •í•œë‹¤.

![](https://hackmd.io/_uploads/Bk2orCrvh.png)

![](https://hackmd.io/_uploads/H1iaHAHwh.png)

- íƒ€ê²Ÿ í(Q1, Q2)ì— ì—°ê²°ë˜ì–´ ìˆëŠ” ë‘ ê°œì˜ ì†ŒìŠ¤(S1, S2)
- ê·¸ë¦¬ê³  ë§¨ ì•„ë˜ì— ìƒí˜¸ ë°°ì œ íì¸ EQ, ë˜ ë‹¤ë¥¸ ì§ë ¬ íë¥¼ ì¶”ê°€í•˜ì—¬ ì‘ì€ íŠ¸ë¦¬ë¥¼ í˜•ì„±í•  ìˆ˜ ìˆë‹¤.


![](https://hackmd.io/_uploads/rJHPU0BP2.png)


```swift 
let Q1 = DispatchQueue(label: "Q1", 
                       target: EQ)
let Q2 = DispatchQueue(label: "Q2", 
                       target: EQ)
```

ì´ ë°©ë²•ì€ ë‹¨ìˆœíˆ Optional Target Argumentë¥¼ ë””ìŠ¤íŒ¨ì¹˜ í ìƒì„±ìì—ê²Œ ì „ë‹¬í•˜ëŠ” ê²ƒì´ë‹¤. ë”°ë¼ì„œ, ì´ ì „ì²´ íŠ¸ë¦¬ì— ëŒ€í•´ ê³µìœ ëœ ë‹¨ì¼ ìƒí˜¸ ë°°ì œ ì»¨í…ìŠ¤íŠ¸(Shared Single Mutual Exclusion Context)ë¥¼ ì œê³µí•œë‹¤.

![](https://hackmd.io/_uploads/By8gvArvn.png)